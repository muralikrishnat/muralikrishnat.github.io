<!DOCTYPE html>
<html lang="en">

<head>
    <title></title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <div class="canvas-container">

    </div>
    <div>
        <input type="file" onchange="handleImage(event)" />
        <div class="logger"></div>
    </div>
    <script src="exif.js"></script>
    <script>
        var $ = function (sel) {
            return document.querySelector(sel);
        };

        var NE = function (eName) {
            return document.createElement(eName);
        };

        var logger = function (...args) {
            var log = NE('DIV');
            args.forEach(a => {
                log.append(a);
            });
            $('.logger').append(log);
        };

        logger.clear = function () {
            $('.logger').innerHTML = '';
        };

        var drawToCanvas = function (ctx, w, h) {
            $('.canvas-container').append(img);
            var styles = getComputedStyle(img, null);
            logger('img tag styles W:', styles.width, ' H: ', styles.height)
            var canvasElem = NE('CANVAS');
            var ctx = canvasElem.getContext('2d');
            canvasElem.width = parseInt(styles.width);
            canvasElem.height = parseInt(styles.height);


            ctx.drawImage(img, 0, 0, canvasElem.width, canvasElem.height);

            $('.canvas-container').append(canvasElem);
        };

        function process() {
            var dv = new DataView(this.result);
            var offset = 0,
                recess = 0;
            var pieces = [];
            var i = 0;
            if (dv.getUint16(offset) == 0xffd8) {
                offset += 2;
                var app1 = dv.getUint16(offset);
                offset += 2;
                while (offset < dv.byteLength) {
                    if (app1 == 0xffe1) {

                        pieces[i] = {
                            recess: recess,
                            offset: offset - 2
                        };
                        recess = offset + dv.getUint16(offset);
                        i++;
                    } else if (app1 == 0xffda) {
                        break;
                    }
                    offset += dv.getUint16(offset);
                    var app1 = dv.getUint16(offset);
                    offset += 2;
                }
                if (pieces.length > 0) {
                    var newPieces = [];
                    pieces.forEach(function (v) {
                        newPieces.push(this.result.slice(v.recess, v.offset));
                    }, this);
                    newPieces.push(this.result.slice(recess));
                    var br = new Blob(newPieces, {
                        type: 'image/jpeg'
                    });
                    var img = new Image();
                    img.onload = function () {
                        img.style.width = '100%';
                        $('.canvas-container').append(img);
                    };
                    img.src = URL.createObjectURL(br);
                }
            }


        }


        var handleImage = function (e) {
            var files = e.target.files;
            var img = new Image();
            img.onload = function () {
                img.style.width = '100%';
                // $('.canvas-container').append(img);
                EXIF.getImageData(img, function () {
                    let exifdata = img.exifdata;
                    let width = exifdata.PixelXDimension;
                    let height = exifdata.PixelYDimension;
                    var canvasElem = NE('CANVAS');
                    var ctx = canvasElem.getContext('2d');

                    if (exifdata.Orientation === 6) {
                        width = exifdata.PixelYDimension;
                        height = exifdata.PixelXDimension;
                        canvasElem.width = width
                        canvasElem.height = height;
                        ctx.translate(width / 2, height / 2);
                        ctx.rotate(90 * Math.PI / 180);

                        ctx.drawImage(img, -height / 2, -width / 2, height, width);
                    } else {

                        canvasElem.width = width
                        canvasElem.height = height;
                        ctx.drawImage(img, 0, 0);
                    }


                    $('.canvas-container').append(canvasElem);
                    canvasElem.style.border = '1px solid red';
                    canvasElem.style.width = '100%';
                    console.log(exifdata);
                    logger('Orientation : ', exifdata.Orientation, ' Dimenssions W: ', width, ' H:',
                        height);
                });
            };
            img.src = window.URL.createObjectURL(files[0]);
        };
        var handleImage2 = function (e) {
            var files = e.target.files;
            var reader = new FileReader();
            reader.onload = function (event) {
                var img = new Image();
                img.onload = function () {
                    // //alert('w x h ' + img.width + ' h: ' + img.height);
                    img.style.width = '100%';
                    EXIF.getImageData(img, function (gg) {
                        let exifdata = img.exifdata;

                        logger('Orientation : ', exifdata.Orientation);
                    });
                };
                img.src = window.URL.createObjectURL(files[0]);
                //var exif = EXIF.readFromBinaryFile(new BinaryFile(event.target['result']));

                //alert('exif data ', exif.Orientation);
                e.target.value = null;


            };
            reader.readAsDataURL(e.target.files[0]);

            // var img = document.createElement("img");
            // img.src = window.URL.createObjectURL(files[0]);
            // img.style.width = '100%';
            // img.style.border = '2px solid red';
            // $('.canvas-container').append(img);
        };
    </script>
</body>

</html>