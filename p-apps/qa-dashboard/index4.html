<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA Flow - Automation Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f8fafc;
            min-height: 100vh;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            border-color: rgba(59, 130, 246, 0.5);
            background: rgba(255, 255, 255, 0.05);
        }

        .node-connector {
            position: absolute;
            left: 28px;
            top: 40px;
            bottom: -20px;
            width: 2px;
            background: rgba(59, 130, 246, 0.3);
            z-index: 0;
        }

        .active-tab {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="max-w-7xl mx-auto space-y-6">
        <!-- Sidebar/Nav -->
        <nav class="glass rounded-2xl p-4 flex justify-between items-center sticky top-4 z-50">
            <div class="flex items-center space-x-3">
                <div class="bg-blue-600 p-2 rounded-lg">
                    <i class="fas fa-microchip text-white"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight">QA<span class="text-blue-500">Flow</span></h1>
            </div>
            <div class="flex space-x-2 md:space-x-6">
                <button onclick="showSection('dashboard')" class="nav-btn active-tab px-3 py-1 transition-all" id="btn-dashboard">Dashboard</button>
                <button onclick="showSection('journeys')" class="nav-btn px-3 py-1 text-slate-400 hover:text-white transition-all" id="btn-journeys">Journeys</button>
                <button onclick="showSection('scheduler')" class="nav-btn px-3 py-1 text-slate-400 hover:text-white transition-all" id="btn-scheduler">Scheduler</button>
            </div>
        </nav>

        <!-- DASHBOARD SECTION -->
        <section id="section-dashboard" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="glass-card p-6 rounded-2xl">
                    <p class="text-slate-400 text-sm mb-1">Total Journeys</p>
                    <h2 class="text-3xl font-bold" id="stat-total">12</h2>
                    <div class="mt-4 flex items-center text-xs text-green-400">
                        <i class="fas fa-arrow-up mr-1"></i> +2 this week
                    </div>
                </div>
                <div class="glass-card p-6 rounded-2xl">
                    <p class="text-slate-400 text-sm mb-1">Test Coverage</p>
                    <h2 class="text-3xl font-bold">84.2%</h2>
                    <div class="w-full bg-slate-800 rounded-full h-1.5 mt-4">
                        <div class="bg-blue-500 h-1.5 rounded-full" style="width: 84%"></div>
                    </div>
                </div>
                <div class="glass-card p-6 rounded-2xl border-l-4 border-l-green-500">
                    <p class="text-slate-400 text-sm mb-1">Passed (Last 24h)</p>
                    <h2 class="text-3xl font-bold text-green-400" id="stat-passed">156</h2>
                </div>
                <div class="glass-card p-6 rounded-2xl border-l-4 border-l-red-500">
                    <p class="text-slate-400 text-sm mb-1">Failed (Last 24h)</p>
                    <h2 class="text-3xl font-bold text-red-400" id="stat-failed">4</h2>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 glass-card p-6 rounded-2xl">
                    <h3 class="text-lg font-semibold mb-6 flex justify-between">
                        Recent Performance
                        <span class="text-xs font-normal text-slate-500">Metrics aggregated by journey</span>
                    </h3>
                    <div class="space-y-4" id="perf-list">
                        <!-- Items rendered dynamically -->
                    </div>
                </div>
                <div class="glass-card p-6 rounded-2xl">
                    <h3 class="text-lg font-semibold mb-6">Automation Health</h3>
                    <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-slate-300">Steps Executed</span>
                            <span class="font-mono text-blue-400">12,480</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-slate-300">Avg Execution Time</span>
                            <span class="font-mono text-blue-400">42s</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-slate-300">Network Load</span>
                            <span class="font-mono text-blue-400">1.2 GB</span>
                        </div>
                        <hr class="border-slate-800">
                        <div class="pt-2">
                            <p class="text-xs text-slate-500 uppercase font-bold tracking-widest mb-4">Top Failure Nodes</p>
                            <div class="space-y-3">
                                <div class="flex items-center text-sm">
                                    <span class="w-8 h-8 rounded bg-red-500/20 text-red-500 flex items-center justify-center mr-3 text-xs">A</span>
                                    <div class="flex-1">
                                        <div class="flex justify-between mb-1">
                                            <span>Login Timeout</span>
                                            <span class="text-slate-400">12%</span>
                                        </div>
                                        <div class="w-full bg-slate-800 h-1 rounded-full">
                                            <div class="bg-red-500 h-1 rounded-full" style="width: 12%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- JOURNEYS LIST SECTION -->
        <section id="section-journeys" class="hidden space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">User Journeys</h2>
                <button onclick="createNewJourney()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-xl text-sm font-medium transition-all shadow-lg shadow-blue-900/20">
                    <i class="fas fa-plus mr-2"></i> New Journey
                </button>
            </div>
            <div class="glass rounded-2xl overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-white/5 border-b border-white/5">
                        <tr>
                            <th class="px-6 py-4 text-xs uppercase font-bold text-slate-500">Journey Name</th>
                            <th class="px-6 py-4 text-xs uppercase font-bold text-slate-500">Status</th>
                            <th class="px-6 py-4 text-xs uppercase font-bold text-slate-500">Steps</th>
                            <th class="px-6 py-4 text-xs uppercase font-bold text-slate-500">Last Activity</th>
                            <th class="px-6 py-4 text-xs uppercase font-bold text-slate-500 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="journey-table-body">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- SCHEDULER SECTION -->
        <section id="section-scheduler" class="hidden space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Execution Schedules</h2>
                <button onclick="addSchedule()" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl text-sm font-medium transition-all">
                    <i class="fas fa-calendar-plus mr-2"></i> Add Schedule
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="scheduler-list">
                <!-- Schedules go here -->
            </div>
        </section>

        <!-- JOURNEY EDITOR (MODAL OVERLAY) -->
        <div id="editor-overlay" class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
            <div class="glass w-full max-w-5xl max-h-[90vh] rounded-3xl overflow-hidden flex flex-col shadow-2xl border border-white/10">
                <!-- Editor Header -->
                <div class="p-6 border-b border-white/10 flex justify-between items-center bg-white/5">
                    <div>
                        <input id="edit-journey-name" type="text" class="bg-transparent text-xl font-bold outline-none border-b border-transparent focus:border-blue-500" value="New Journey">
                        <p class="text-xs text-slate-500 mt-1">Journey ID: <span id="edit-journey-id">---</span></p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="closeEditor()" class="px-4 py-2 rounded-xl text-sm text-slate-400 hover:bg-white/5">Cancel</button>
                        <button onclick="saveJourney()" class="px-6 py-2 bg-blue-600 rounded-xl text-sm font-bold shadow-lg shadow-blue-600/20">Save Journey</button>
                    </div>
                </div>

                <!-- Editor Body -->
                <div class="flex-1 overflow-y-auto p-8 relative bg-[#0a0f18]/50">
                    <div id="step-container" class="max-w-2xl mx-auto space-y-4">
                        <!-- Step items here -->
                    </div>
                    
                    <div class="max-w-2xl mx-auto mt-8 border-t border-white/5 pt-8 flex justify-center">
                        <button onclick="addStep()" class="group flex flex-col items-center">
                            <div class="w-12 h-12 rounded-full border-2 border-dashed border-slate-700 flex items-center justify-center group-hover:border-blue-500 group-hover:bg-blue-500/10 transition-all">
                                <i class="fas fa-plus text-slate-500 group-hover:text-blue-500"></i>
                            </div>
                            <span class="text-xs text-slate-500 mt-2 group-hover:text-blue-400">Append New Step</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- NOTIFICATION TOAST -->
        <div id="toast" class="fixed bottom-8 right-8 glass px-6 py-3 rounded-2xl shadow-2xl border border-white/20 transform translate-y-20 opacity-0 transition-all duration-300 z-[200] flex items-center space-x-3">
            <i class="fas fa-circle-check text-green-400"></i>
            <span id="toast-msg">Success!</span>
        </div>
    </div>

    <script>
        // State Management
        let journeys = [
            { id: 'JR-001', name: 'User Login & Profile Update', status: 'Passed', steps: 8, lastRun: '2023-10-24 14:30', nodes: [
                { id: 1, action: 'navigate', value: 'https://app.example.com', desc: 'Load Landing Page' },
                { id: 2, action: 'input', value: '#email', data: 'user@test.com', desc: 'Enter Email' },
                { id: 3, action: 'input', value: '#password', data: '******', desc: 'Enter Password' },
                { id: 4, action: 'click', value: '.btn-login', desc: 'Submit Login' },
                { id: 5, action: 'condition', value: 'if page_title contains "Dashboard"', branches: [
                    { label: 'True', steps: [ { id: 51, action: 'click', value: '#profile', desc: 'Go to Profile' } ] },
                    { label: 'False', steps: [ { id: 52, action: 'assert', value: '.error-msg', desc: 'Check for error' } ] }
                ], desc: 'Validate Login Success' }
            ], perf: { pageLoad: '1.2s', data: '450kb', network: '1.8mb', exec: '12s' } },
            { id: 'JR-002', name: 'Add to Cart Flow', status: 'Failed', steps: 12, lastRun: '2023-10-24 15:10', nodes: [], perf: { pageLoad: '2.1s', data: '890kb', network: '4.2mb', exec: '45s' } },
            { id: 'JR-003', name: 'Search Algorithm Check', status: 'Active', steps: 5, lastRun: '2023-10-24 16:45', nodes: [], perf: { pageLoad: '0.8s', data: '120kb', network: '0.5mb', exec: '4s' } }
        ];

        let schedules = [
            { id: 1, journeyName: 'User Login & Profile Update', type: 'Daily', time: '02:00 AM', next: 'Tomorrow', active: true },
            { id: 2, journeyName: 'Add to Cart Flow', type: 'Weekly', time: 'Monday 09:00 AM', next: 'Oct 30', active: false }
        ];

        let currentEditingJourney = null;

        const ACTIONS = [
            { id: 'navigate', label: 'Navigate', icon: 'fa-globe' },
            { id: 'click', label: 'Click', icon: 'fa-mouse-pointer' },
            { id: 'input', label: 'Input Text', icon: 'fa-keyboard' },
            { id: 'wait', label: 'Wait/Sleep', icon: 'fa-clock' },
            { id: 'assert', label: 'Assertion', icon: 'fa-check-double' },
            { id: 'condition', label: 'Branch/Condition', icon: 'fa-code-branch' }
        ];

        // Initial render
        window.onload = () => {
            renderDashboard();
            renderJourneys();
            renderSchedules();
        };

        function showSection(section) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`section-${section}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-tab', 'text-white'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.add('text-slate-400'));
            
            const activeBtn = document.getElementById(`btn-${section}`);
            activeBtn.classList.add('active-tab', 'text-white');
            activeBtn.classList.remove('text-slate-400');
        }

        function renderDashboard() {
            const perfList = document.getElementById('perf-list');
            perfList.innerHTML = journeys.map(j => `
                <div class="flex items-center justify-between p-3 rounded-xl bg-white/5 border border-white/5">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center ${j.status === 'Passed' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
                            <i class="fas ${j.status === 'Passed' ? 'fa-check' : 'fa-times'}"></i>
                        </div>
                        <div>
                            <h4 class="text-sm font-semibold">${j.name}</h4>
                            <p class="text-[10px] text-slate-500 uppercase tracking-tighter">Completed at ${j.lastRun}</p>
                        </div>
                    </div>
                    <div class="flex space-x-8">
                        <div class="text-center">
                            <p class="text-[10px] text-slate-500 uppercase">Load</p>
                            <p class="text-xs font-mono">${j.perf.pageLoad}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[10px] text-slate-500 uppercase">Size</p>
                            <p class="text-xs font-mono">${j.perf.network}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[10px] text-slate-500 uppercase">Exec</p>
                            <p class="text-xs font-mono text-blue-400">${j.perf.exec}</p>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('stat-total').innerText = journeys.length;
            document.getElementById('stat-passed').innerText = journeys.filter(j => j.status === 'Passed').length * 42; // Simulated aggregate
            document.getElementById('stat-failed').innerText = journeys.filter(j => j.status === 'Failed').length * 2;
        }

        function renderJourneys() {
            const tbody = document.getElementById('journey-table-body');
            tbody.innerHTML = journeys.map(j => `
                <tr class="border-b border-white/5 hover:bg-white/[0.02] transition-colors group">
                    <td class="px-6 py-4">
                        <span class="font-medium">${j.name}</span>
                        <div class="text-[10px] text-slate-500 font-mono">${j.id}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-[10px] font-bold ${j.status === 'Passed' ? 'bg-green-500/20 text-green-400' : j.status === 'Failed' ? 'bg-red-500/20 text-red-400' : 'bg-blue-500/20 text-blue-400'}">
                            ${j.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-slate-300">${j.steps} steps</td>
                    <td class="px-6 py-4 text-sm text-slate-400">${j.lastRun}</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="openEditor('${j.id}')" class="p-2 text-slate-400 hover:text-blue-400 transition-colors"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteJourney('${j.id}')" class="p-2 text-slate-400 hover:text-red-400 transition-colors"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function renderSchedules() {
            const list = document.getElementById('scheduler-list');
            list.innerHTML = schedules.map(s => `
                <div class="glass-card p-6 rounded-2xl relative">
                    <div class="flex justify-between items-start mb-4">
                        <div class="bg-blue-600/20 p-2 rounded-lg text-blue-500">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="flex items-center">
                            <span class="text-[10px] uppercase font-bold text-slate-500 mr-2">${s.active ? 'Active' : 'Paused'}</span>
                            <div class="w-10 h-5 bg-slate-800 rounded-full relative cursor-pointer" onclick="toggleSchedule(${s.id})">
                                <div class="absolute w-4 h-4 rounded-full bg-white top-0.5 transition-all ${s.active ? 'right-0.5 bg-blue-500' : 'left-0.5'}"></div>
                            </div>
                        </div>
                    </div>
                    <h4 class="font-bold mb-1">${s.journeyName}</h4>
                    <p class="text-sm text-slate-400 mb-6">${s.type} â€¢ ${s.time}</p>
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-slate-500">Next Run: <span class="text-blue-400">${s.next}</span></span>
                        <button onclick="removeSchedule(${s.id})" class="text-red-500/50 hover:text-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        // Editor Logic
        function openEditor(id) {
            currentEditingJourney = journeys.find(j => j.id === id) || { 
                id: 'JR-' + Math.floor(Math.random()*1000), 
                name: 'New Journey', 
                nodes: [], 
                status: 'Draft',
                steps: 0,
                lastRun: 'Just now',
                perf: { pageLoad: '-', data: '-', network: '-', exec: '-' }
            };

            // Deep clone to avoid editing source until saved
            currentEditingJourney = JSON.parse(JSON.stringify(currentEditingJourney));

            document.getElementById('edit-journey-name').value = currentEditingJourney.name;
            document.getElementById('edit-journey-id').innerText = currentEditingJourney.id;
            renderNodes();
            document.getElementById('editor-overlay').classList.remove('hidden');
        }

        function renderNodes(containerId = 'step-container', nodes = currentEditingJourney.nodes, parentIndex = null, branchLabel = null) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (nodes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-slate-500 border-2 border-dashed border-white/5 rounded-2xl">
                        <p class="text-xs">No steps in this path.</p>
                        <button onclick="addStepToPath('${containerId}', ${parentIndex}, '${branchLabel}')" class="text-blue-400 text-xs hover:underline mt-1">Add step</button>
                    </div>
                `;
                return;
            }

            nodes.forEach((node, index) => {
                const nodeEl = document.createElement('div');
                nodeEl.className = 'relative';
                
                const isCondition = node.action === 'condition';

                nodeEl.innerHTML = `
                    <div class="node-connector"></div>
                    <div class="glass-card p-4 rounded-2xl relative z-10 flex flex-col space-y-3 border-l-4 ${isCondition ? 'border-l-purple-500' : 'border-l-blue-500'}">
                        <div class="flex items-start space-x-4">
                            <div class="bg-slate-800 w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-slate-400 shrink-0">
                                ${index + 1}
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-center mb-2">
                                    <select onchange="updateNodeAction('${containerId}', ${index}, this.value, ${parentIndex}, '${branchLabel}')" class="bg-transparent font-bold outline-none text-sm cursor-pointer">
                                        ${ACTIONS.map(a => `<option value="${a.id}" ${node.action === a.id ? 'selected' : ''} class="bg-slate-900">${a.label}</option>`).join('')}
                                    </select>
                                    <div class="flex space-x-1">
                                        <button onclick="moveNodeInPath('${containerId}', ${index}, -1, ${parentIndex}, '${branchLabel}')" class="p-1 hover:text-blue-400 text-slate-600"><i class="fas fa-arrow-up text-[10px]"></i></button>
                                        <button onclick="moveNodeInPath('${containerId}', ${index}, 1, ${parentIndex}, '${branchLabel}')" class="p-1 hover:text-blue-400 text-slate-600"><i class="fas fa-arrow-down text-[10px]"></i></button>
                                        <button onclick="removeNodeFromPath('${containerId}', ${index}, ${parentIndex}, '${branchLabel}')" class="p-1 hover:text-red-400 text-slate-600"><i class="fas fa-times text-[10px]"></i></button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <input type="text" placeholder="${isCondition ? 'Logic expression' : 'Selector or Target'}" value="${node.value || ''}" onchange="updateNodeValue('${containerId}', ${index}, 'value', this.value, ${parentIndex}, '${branchLabel}')" class="bg-white/5 border border-white/5 rounded-lg px-3 py-1.5 text-xs outline-none focus:border-blue-500">
                                    <input type="text" placeholder="Description" value="${node.desc || ''}" onchange="updateNodeValue('${containerId}', ${index}, 'desc', this.value, ${parentIndex}, '${branchLabel}')" class="bg-white/5 border border-white/5 rounded-lg px-3 py-1.5 text-xs outline-none focus:border-blue-500">
                                </div>
                            </div>
                        </div>

                        ${isCondition ? `
                            <div class="ml-12 mt-4 space-y-4 border-l-2 border-dashed border-purple-500/30 pl-4">
                                <div class="space-y-2">
                                    <div class="flex justify-between items-center">
                                        <p class="text-[10px] font-bold text-green-400 uppercase tracking-widest">Path: True</p>
                                        <button onclick="addStepToPath('true-branch-${node.id}', ${index}, 'True')" class="text-[10px] bg-green-500/10 hover:bg-green-500/20 text-green-400 px-2 py-0.5 rounded-full"><i class="fas fa-plus mr-1"></i> Add Step</button>
                                    </div>
                                    <div id="true-branch-${node.id}" class="space-y-3"></div>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex justify-between items-center">
                                        <p class="text-[10px] font-bold text-red-400 uppercase tracking-widest">Path: False</p>
                                        <button onclick="addStepToPath('false-branch-${node.id}', ${index}, 'False')" class="text-[10px] bg-red-500/10 hover:bg-red-500/20 text-red-400 px-2 py-0.5 rounded-full"><i class="fas fa-plus mr-1"></i> Add Step</button>
                                    </div>
                                    <div id="false-branch-${node.id}" class="space-y-3"></div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <button onclick="insertNodeInPath('${containerId}', ${index}, ${parentIndex}, '${branchLabel}')" class="absolute -bottom-6 left-5 bg-slate-900 text-slate-400 hover:text-blue-400 hover:scale-110 transition-all border border-white/10 w-6 h-6 rounded-full flex items-center justify-center z-20">
                            <i class="fas fa-plus text-[10px]"></i>
                        </button>
                    </div>
                `;
                container.appendChild(nodeEl);

                // Recursively render branches if condition
                if (isCondition) {
                    if (!node.branches) {
                        node.branches = [
                            { label: 'True', steps: [] },
                            { label: 'False', steps: [] }
                        ];
                    }
                    renderNodes(`true-branch-${node.id}`, node.branches[0].steps, index, 'True');
                    renderNodes(`false-branch-${node.id}`, node.branches[1].steps, index, 'False');
                }
            });
        }

        // Logic for handling deep paths in conditional nodes
        function getTargetList(parentIndex, branchLabel) {
            if (parentIndex === null) return currentEditingJourney.nodes;
            const parentNode = currentEditingJourney.nodes[parentIndex];
            const branch = parentNode.branches.find(b => b.label === branchLabel);
            return branch.steps;
        }

        function addStep() {
            addStepToPath('step-container', null, null);
        }

        function addStepToPath(containerId, parentIndex, branchLabel) {
            const list = getTargetList(parentIndex, branchLabel);
            list.push({ id: Date.now() + Math.random(), action: 'click', value: '', desc: '' });
            renderNodes();
        }

        function insertNodeInPath(containerId, index, parentIndex, branchLabel) {
            const list = getTargetList(parentIndex, branchLabel);
            list.splice(index + 1, 0, { id: Date.now() + Math.random(), action: 'click', value: '', desc: '' });
            renderNodes();
        }

        function removeNodeFromPath(containerId, index, parentIndex, branchLabel) {
            const list = getTargetList(parentIndex, branchLabel);
            list.splice(index, 1);
            renderNodes();
        }

        function moveNodeInPath(containerId, index, direction, parentIndex, branchLabel) {
            const list = getTargetList(parentIndex, branchLabel);
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= list.length) return;
            const temp = list[index];
            list[index] = list[newIndex];
            list[newIndex] = temp;
            renderNodes();
        }

        function updateNodeValue(containerId, index, field, value, parentIndex, branchLabel) {
            const list = getTargetList(parentIndex, branchLabel);
            list[index][field] = value;
        }

        function updateNodeAction(containerId, index, value, parentIndex, branchLabel) {
            const list = getTargetList(parentIndex, branchLabel);
            list[index].action = value;
            if (value === 'condition' && !list[index].branches) {
                list[index].branches = [
                    { label: 'True', steps: [] },
                    { label: 'False', steps: [] }
                ];
            }
            renderNodes();
        }

        function saveJourney() {
            const name = document.getElementById('edit-journey-name').value;
            currentEditingJourney.name = name;
            
            // Recalculate total steps including nested ones
            const countSteps = (nodes) => {
                let count = nodes.length;
                nodes.forEach(n => {
                    if (n.branches) {
                        n.branches.forEach(b => count += countSteps(b.steps));
                    }
                });
                return count;
            };
            
            currentEditingJourney.steps = countSteps(currentEditingJourney.nodes);
            
            const existingIndex = journeys.findIndex(j => j.id === currentEditingJourney.id);
            if (existingIndex > -1) {
                journeys[existingIndex] = currentEditingJourney;
            } else {
                journeys.push(currentEditingJourney);
            }
            
            renderJourneys();
            renderDashboard();
            showToast('Journey saved successfully');
            closeEditor();
        }

        function closeEditor() {
            document.getElementById('editor-overlay').classList.add('hidden');
        }

        function createNewJourney() {
            openEditor(null);
        }

        function deleteJourney(id) {
            if(confirm('Are you sure you want to delete this journey?')) {
                journeys = journeys.filter(j => j.id !== id);
                renderJourneys();
                renderDashboard();
                showToast('Journey deleted', 'red');
            }
        }

        // Utils
        function showToast(msg, color = 'green') {
            const toast = document.getElementById('toast');
            const icon = toast.querySelector('i');
            document.getElementById('toast-msg').innerText = msg;
            
            icon.className = `fas fa-circle-check text-${color}-400`;
            toast.classList.remove('translate-y-20', 'opacity-0');
            
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        function toggleSchedule(id) {
            const s = schedules.find(x => x.id === id);
            if (s) {
                s.active = !s.active;
                renderSchedules();
                showToast(s.active ? 'Schedule resumed' : 'Schedule paused');
            }
        }

        function removeSchedule(id) {
            schedules = schedules.filter(s => s.id !== id);
            renderSchedules();
            showToast('Schedule removed');
        }

        function addSchedule() {
            if (journeys.length === 0) return showToast('Create a journey first', 'red');
            const j = journeys[0];
            schedules.push({
                id: Date.now(),
                journeyName: j.name,
                type: 'Daily',
                time: '12:00 PM',
                next: 'Tomorrow',
                active: true
            });
            renderSchedules();
            showToast('New schedule created');
        }
    </script>
</body>
</html>